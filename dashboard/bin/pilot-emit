#!/usr/bin/env bash
# pilot-emit - Emit state to PILOT dashboard
# Usage: pilot-emit phase OBSERVE
#        pilot-emit learning "Discovered new pattern"
#        pilot-emit identity GOALS

DASHBOARD_DIR="$HOME/.kiro/pilot/dashboard"
SESSIONS_DIR="$DASHBOARD_DIR/sessions"
EVENTS_FILE="$DASHBOARD_DIR/events.jsonl"

# Get or create session ID
SESSION_ID="${PILOT_SESSION:-pilot-$$}"

mkdir -p "$SESSIONS_DIR"

emit_phase() {
    local phase="$1"
    local timestamp=$(date +%s)
    
    # Update session file
    cat > "$SESSIONS_DIR/${SESSION_ID}.json" << EOF
{"id":"$SESSION_ID","phase":"$phase","updated":$timestamp}
EOF
    
    # Append event
    echo "{\"type\":\"phase\",\"sessionId\":\"$SESSION_ID\",\"phase\":\"$phase\",\"timestamp\":$timestamp}" >> "$EVENTS_FILE"
}

emit_learning() {
    local title="$1"
    local timestamp=$(date +%s)
    
    echo "{\"type\":\"learning\",\"sessionId\":\"$SESSION_ID\",\"title\":\"$title\",\"timestamp\":$timestamp}" >> "$EVENTS_FILE"
}

emit_identity() {
    local component="$1"
    local timestamp=$(date +%s)
    
    echo "{\"type\":\"identity\",\"sessionId\":\"$SESSION_ID\",\"component\":\"$component\",\"timestamp\":$timestamp}" >> "$EVENTS_FILE"
}

case "$1" in
    phase)    emit_phase "$2" ;;
    learning) emit_learning "$2" ;;
    identity) emit_identity "$2" ;;
    *)        echo "Usage: pilot-emit {phase|learning|identity} <value>" ;;
esac
